<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" content="portfolio and blog of myles borins"><meta name="author" content="Myles Borins"><link rel="icon" type="image/png" href="/images/favicon.ico"><link href="/styles/main.css" rel="stylesheet"><title>MylesBorins.com</title></head><body><div id="header"><div id="header-accent"><div class="big-guy light-grey"></div><div class="medium-guy dark-grey"></div><div class="tiny-guy almost-black"></div></div></div><nav class="social-links group small" id="sticky-social"><ul class="nav-links-social"><li class="text-link"><a class="icon-twitter2" href="https://www.twitter.com/MylesBorins"></a></li><li class="text-link"><a class="icon-github3" href="https://www.github.com/MylesBorins"></a></li><li class="text-link"><a class="icon-soundcloud" href="https://www.soundcloud.com/rowbit"></a></li><li class="text-link"><a class="icon-linkedin" href="https://www.linkedin.com/in/MylesBorins"></a></li><li class="text-link"><a class="icon-vimeo2" href="https://vimeo.com/MylesBorins"></a></li><li class="text-link"><a class="icon-envelope" href="mailto:myles.borins@gmail.com"></a></li></ul></nav><div class="meta-white"><div class="center shift-up-body"> <div class="post-head group"><a href="/blog/deploying-a-static-site-with-grunt-and-git/"><h1 class="post-title">Deploying a Static site with Grunt and Git</h1></a><div class="post-date">Published 1/7/2014</div></div><div class="post-body markdown"><pre><code class="language-bash">git push linode
</code></pre>
<p>I have wanted to deploy a site with a single git push for quite some time, but could never quite figure out how to do it.  This evening I finally figured it out and it wasn&#39;t so bad.</p>
<hr class="top-three"><h3>you can push all day</h3><hr class="bottom-three"><p>This was something that stumped me for a while... every time I tried to push to a repo on my own server rather than github I would be faced with this error</p>
<pre><code>git push linode

Total 0 (delta 0), reused 0 (delta 0)
remote: error: refusing to update checked out branch: refs/heads/master
remote: error: By default, updating the current branch in a non-bare repository
remote: error: is denied, because it will make the index and work tree inconsistent
remote: error: with what you pushed, and will require &#39;git reset --hard&#39; to match
remote: error: the work tree to HEAD.
remote: error:
remote: error: You can set &#39;receive.denyCurrentBranch&#39; configuration variable to
remote: error: &#39;ignore&#39; or &#39;warn&#39; in the remote repository to allow pushing into
remote: error: its current branch; however, this is not recommended unless you
remote: error: arranged to update its work tree to match what you pushed in some
remote: error: other way.
remote: error:
remote: error: To squelch this message and still keep the default behavior, set
remote: error: &#39;receive.denyCurrentBranch&#39; configuration variable to &#39;refuse&#39;.
To use@MylesBorins.com:some/dir/MylesBorins.com/.git
! [remote rejected] master -&gt; master (branch is currently checked out)
</code></pre>
<hr class="top-three"><h3>double down with a bare repo</h3><hr class="bottom-three"><p>The problem was that I was trying to push to a non bare repo, this just won&#39;t work.  I needed to create a second bare repo that I would push to, and use a git hook to get my cloned repo to update itself.  What took me a while to wrap my head around, was that once you create the bare repo, you can actually make a clone from that local repo, and use it as a remote.  </p>
<p>What I particularly like about this setup is that the deployment of this static site is insular, making it so that I am not relying on github to be a central repository (a pattern I too often find myself stuck in).</p>
<p>So to recap I have 3 repos:</p>
<ul>
<li>a local repo</li>
<li>a deployment repo (on linode)</li>
<li>a bare repo (on linode)</li>
</ul>
<p>On linode I created a folder for bare repos in my home directory. I added the bare repo as a remote to 
I then moved to my local git repo and added the bare repo on linode as a remote.</p>
<pre><code class="language-bash">[ local ~ ] ssh user@si.te
[ linode ~ ] mkdir bare &amp;&amp; cd bare
[ linode ~/bare ] git init --bare site.git
~~~cntrl-d~~~
[ local ~/github/site ] git remote add linode \
     user@somesi.te:bare/site.git
[ local ~/github/site ] git push linode master
</code></pre>
<p>Now that the bare repo has some data we can add it as a remote in the deployment repo</p>
<pre><code class="language-bash">[ linode ~/bare ] cd /www/site/
[ linode /www/site ] git remote add local /path/to/usr/bare/site.git
</code></pre>
<p>Now the last thing we need to do is make a post-update script for the bare repo to tell our deployment repo to pull from it, and run grunt.</p>
<p>/path/to/usr/bare/site.git/hooks/post-update</p>
<pre><code class="language-bash"># !/bin/sh
export PATH=&quot;/a/path/gems/9.0.0.1/bin:$PATH:.&quot;

GIT_WORK_TREE=/www/site/
GIT_DIR=/www/site/.git

cd /www/site/
git pull local master

grunt build
</code></pre>
<p>Finally, after all of this work you can deploy with</p>
<pre><code>git push linode
</code></pre>
<p>and all is well in the universe.</p>
</div><div class="pagination group"><a class="newer" href="/page/9/">Newer &#8594;</a></div></div></div><div id="footer"><div class="tiny-guy almost-black"></div><div class="medium-guy dark-grey"></div><div class="big-guy light-grey"></div><div class="center"><nav class="group"><h1 class="name"><a href="/">Myles Borins</a></h1><ul class="nav-links"><li class="text-link"><a href="/about.html">about</a></li><li class="text-link"><a href="/talks.html">talks</a></li><li class="text-link"><a href="/projects.html">projects</a></li><li class="text-link"><a href="/archives.html">archives</a></li></ul></nav></div></div><script src="/scripts/jquery.min.js"></script><script src="/scripts/sticky-kit.min.js"></script><script src="/scripts/main.js"></script><script>var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-46827582-1']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();</script></body></html>